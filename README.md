#rpmrepo

NOTE: rpmrepo is far from ready. Move along, nothing to see here. Yet.

or, "`reprepro` for RPM packages". Sortof.

I [like](http://grep.be/blog/en/lazyweb/Reprepro_for_RPM) reprepro. It's
a repository manager for Debian package files, with many features. I
don't use most of those features, but I like its mode of operation: you
run a command, files get moved around and things are changed, and then
you have a directory that you can rsync around. There's no need to deal
with all sorts of daemons or webserverscripts or whatnot, you just run a
cronjob, or a trigger from [buildbot](http://buildbot.net), or something
along those lines, and _that's it_. No need to deal with [10GiB mongodb
files](http://pulpproject.org), or setting up a whole [build
system](http://openbuildservice.org) just to be able to automanage a
repository, or whatever.

Before rpmrepo, the RPM world did not have such a tool, at least not one
that I know of. So I wrote rpmrepo.

My goal with rpmrepo is _not_ to be on-par, feature-wise, with
`reprepro`. Instead, I just reimplemented the features from `reprepro`
that I use, and nothing more. It does what I want; it probably doesn't
do what you want. Patches are welcome.

##How to use it

To use `rpmrepo`, you need a base directory containing all its state,
input, and output. In that base directory, you create a directory
`conf`, where you create a file `main.cf`. This file is a perl snippet
that gets sourced from the main script, so make sure it ends with a line
like this:

    1;

otherwise perl gets icky.

In this file, you can set some configuration. The following variables
are known and understood by rpmrepo:

###main variables

- `$basedir`: the base directory where `rpmrepo` starts looking for
  everything else. Note: you can't really modify this yet, because it's
  also used to find the config file. Defaults to the current working
  directory.
- `$repoloc`: the directory (under `$basedir`) under which `rpmrepo`
  writes its output. Defaults to `repository`.
- `$dbloc`: the directory (under `$basedir`) under which `rpmrepo`
  looks for and writes its state databases. Defaults to `db`.
- `$inputloc`: the directory (under `$basedir`) under which `rpmrepo`
  looks for new files to add to one or more repositories.
- `%flavours`: a hash containing options on different types of RPM
  repositories. All repositories contain output generated by
  `createrepo`, but there are a few differences in style, depending on
  the distribution used; this hash defines the different styles. See
  below for more details.
- `%repositories`: The repositories we want to have. The script contains
  an example, but you really want to overwrite this in your main.cf. See
  below for more details.
- `$repomapfield`: the metadata field to use on which to base the
  repository mapping. The script contains an example which might work
  for you, but you might want to do something else instead.
- `$repomapre`: the regular expression applied to `$repomapfield` to
  parse out the key to the entry in the %repomap hash. The result should
  be in `$1`.
- `%repomap`: simple hash mapping output of $repomapre onto an entry in
  `%repositories`.

Two of these three hashes, `%flavours` and `%repositories`, are hashes
of hashes; that is, the entries in those hashes point to anonymous
hashes, which can have multiple keys.

###%flavours

This explains what a repository should look like. Since these should be
varied only per target distribution rather than per repository, you
shouldn't need to modify it. If you do find yourself having to modify
`%flavours`, please send me a patch.

The anonymous hashes should have these keys:

- `basearchs`: the base architectures expected by this flavour. Should
  be an anonymous array. This is `i386` and `x86_64` for fedora-like
  distributions (including Red Hat Enterprise up to and including EL6),
  `i586` and `x86_64` for openSUSE, and just `x86_64` for EL7.
- `index_gpg`: whether to sign the `repomd.xml` file with a
  `repomd.xml.asc` and `repomd.xml.key` file, openSUSE-style.

###%repositories

This lists the repositories we want to have. Its keys should be the
directories (subdirectories of `$repoloc`) where this particular
repository should be written, and its anonymous hashes should contain
the following keys:

- `rpmsign`: set to nonzero if RPM packages in this repository should be
  signed.
- `gpgkey`: the GPG key with which to sign RPM packages. If its flavour
  has `index_gpg` enabled, will also be used to sign `repomd.xml`.
- `enabled`: should usually be set to 1. If set to 0, `rpmrepo` will
  pretend the repository does not exist. A future release of `rpmrepo`
  _may_ remove a repository's state if it does not appear in the
  `%repositories` hash, but this will not happen if it does appear with
  `enabled` set to 0.
- `flavour`: the key into the `%flavours` hash that should be used for
  this repository.
- `nopasswdhack`: if you want to run `rpmrepo` noninteractively, and you
  want it to sign RPM packages, then this _must_ be set to an
  `LD_PRELOAD`able `.so` file which must override the `getpass`
  function. This is because otherwise, `rpmsign` waits forever for you
  to enter a password, _even_ if there is no password on the GPG key.
  Obviously the return value of your overriding `getpass` function
  should be the password on the GPG key.

An example `.c` file for the `nopasswdhack` could look like:

    #include <unistd.h>
    #include <stdio.h>

    char* getpass(const char* prompt) {
        printf("Munch munch -- password request eaten\n");
	return "";
    }

(we add the "password request eaten" message so that if this is
accidentally loaded where it shouldn't be, users may understand what is
happening)

Assuming the above code is stored in `getpass.c`, compile with `gcc -O2
-fPIC -shared -o getpass.so getpass.c`.
